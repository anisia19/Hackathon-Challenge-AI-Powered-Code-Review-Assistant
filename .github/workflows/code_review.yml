name: Local AI Code Review Test

# Triggered on pull requests (opened, updated, or reopened)
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai_review_test:
    runs-on: ubuntu-latest

    # Configure Ollama as a sidecar container service
    services:
      ollama:
        image: ollama/ollama
        ports:
          - 11434:11434
        # Wait for Ollama to start before proceeding
        options: >-
          --health-cmd "ollama --version"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout Repository Code
        # Essential: Fetch repo files on the runner, including action.yml
        uses: actions/checkout@v4

      - name: Wait for Ollama Service
        # Simple delay to ensure Ollama container has fully started
        run: echo "Ollama service is starting..." && sleep 15s

      - name: Run AI Code Review Action
        # Run your local GitHub Action (action.yml in this repo)
        uses: ./
        with:
          # GitHub automatically provides this token
          github-token: ${{ secrets.GITHUB_TOKEN }}

          # URL for the Ollama sidecar container
          ollama-api-url: "http://ollama:11434"

          # The PR number will be automatically injected by GitHub Actions
          # (no need to specify it manually)
